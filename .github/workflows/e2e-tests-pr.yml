name: E2E Tests (PR)

on:
  pull_request:
    branches: [main]
    paths:
      - 'packages/**'
      - 'playground/**'
      - '!packages/docs/**'
      - '.github/workflows/e2e-tests-pr.yml'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run E2E tests against'
        required: true
        default: 'main'
        type: string

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  e2e-pr-tests:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        template: [nodejs, python]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    env:
      CI: true
      NODE_ENV: test
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.event_name == 'pull_request' && github.head_ref || github.ref }}

      - name: Setup
        uses: ./.github/actions/setup

      - name: Get Playwright version
        id: playwright-version
        run: |
          cd packages/e2e
          PLAYWRIGHT_VERSION=$(node -p "require('./package.json').dependencies['@playwright/test'] || require('./package.json').devDependencies['@playwright/test']")
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
            ~/AppData/Local/ms-playwright
            ~/Library/Caches/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}-
            playwright-${{ runner.os }}-

      - name: Install E2E dependencies and browsers
        run: |
          cd packages/e2e
          pnpm install
          pnpm exec playwright install
          pnpm exec playwright install-deps

      - name: Clean previous test artifacts
        run: |
          cd packages/e2e
          pnpm clean

      - name: Verify built CLI
        run: |
          # Verify the built CLI exists
          if [ ! -f "packages/snap/dist/cjs/cli.js" ]; then
            echo "❌ Built CLI not found at packages/snap/dist/cjs/cli.js"
            echo "Available files in dist:"
            ls -la packages/snap/dist/ || echo "dist directory not found"
            exit 1
          fi
          
          # Make CLI executable through node
          echo "✅ Built CLI found at packages/snap/dist/cjs/cli.js"
          node packages/snap/dist/cjs/cli.js --version || echo "CLI version check failed"

      - name: Record test start time
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Run PR E2E tests with built CLI
        id: run_tests
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 2
          retry_on: error
          shell: bash
          command: |
            cd packages/e2e
            echo "🧪 Starting PR E2E tests - Template: ${{ matrix.template }}, OS: ${{ matrix.os }}"
            
            # Export the built CLI path for tests to use
            export MOTIA_CLI_PATH="$GITHUB_WORKSPACE/packages/snap/dist/cjs/cli.js"
            export MOTIA_ANALYTICS_DISABLED=true
            export MOTIA_API_URL=http://localhost:3000
            export TEST_TEMPLATE=${{ matrix.template }}
            
            # Run tests based on template (no sharding)
            if [ "${{ matrix.template }}" == "python" ]; then
              pnpm test:pr:python --reporter=line,html,github
            else
              pnpm test:pr --reporter=line,html,github
            fi

      - name: Record test metrics
        if: always()
        run: |
          TEST_DURATION=$(($(date +%s) - $START_TIME))
          echo "TEST_DURATION=$TEST_DURATION" >> $GITHUB_ENV
          echo "::notice title=Test Duration::${{ matrix.template }} on ${{ matrix.os }} completed in $TEST_DURATION seconds"
          
          # Output performance metrics
          echo "### Performance Metrics - ${{ matrix.os }} - ${{ matrix.template }}" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ${TEST_DURATION}s" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ steps.run_tests.outcome }}" >> $GITHUB_STEP_SUMMARY

      - name: Process test results
        id: test_result
        if: always()
        run: |
          echo "📊 Test Results Summary:"
          echo "- Template: ${{ matrix.template }}"
          echo "- OS: ${{ matrix.os }}"
          echo "- Test outcome: ${{ steps.run_tests.outcome }}"
          echo "- Duration: ${{ env.TEST_DURATION }} seconds"
          
          if [ "${{ steps.run_tests.outcome }}" == "success" ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "✅ PR E2E tests passed for ${{ matrix.template }} on ${{ matrix.os }}"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error title=Test Failed::E2E tests failed for ${{ matrix.template }} on ${{ matrix.os }}"
          
            # Extract and display error summary if available
            if [ -f "packages/e2e/test-results/results.json" ]; then
              echo "### Failed Tests Summary" >> $GITHUB_STEP_SUMMARY
              jq -r '.failures[]' packages/e2e/test-results/results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            fi
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-pr-test-results-${{ github.event.number }}-${{ matrix.os }}-${{ matrix.template }}
          path: |
            packages/e2e/playwright-report/
            packages/e2e/test-results/
            packages/e2e/test-results.xml
          retention-days: 7

      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: PR E2E Tests - ${{ matrix.os }} - ${{ matrix.template }}
          path: 'packages/e2e/test-results/*.xml'
          reporter: jest-junit
          fail-on-error: false
          only-summary: false

      - name: Clean up test artifacts
        if: always()
        run: |
          echo "🧹 Cleaning up test artifacts..."
          
          # Kill any processes on port 3000
          if command -v lsof &> /dev/null; then
            PORT_PIDS=$(lsof -ti:3000 2>/dev/null || true)
            if [ ! -z "$PORT_PIDS" ]; then
              echo "$PORT_PIDS" | xargs -r kill -9 2>/dev/null || true
            fi
          fi
          
          # Clean up any test project directories created during tests
          rm -rf packages/e2e/motia-e2e-test-project* 2>/dev/null || true
          
          echo "✅ Cleanup complete"

  # Aggregate results from all matrix jobs
  check-results:
    needs: e2e-pr-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all test results
        run: |
          echo "📊 Checking results from all test jobs..."
          
          # Get the results from the matrix jobs
          RESULTS='${{ toJSON(needs.e2e-pr-tests.result) }}'
          echo "Matrix job result: $RESULTS"
          
          if [ "$RESULTS" == '"success"' ]; then
            echo "✅ All PR E2E tests passed successfully"
            echo "### PR E2E Tests: PASSED ✅" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ One or more PR E2E tests failed"
            echo "### PR E2E Tests: FAILED ❌" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Comment PR status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ needs.e2e-pr-tests.result }}' === 'success';
            const emoji = result ? '✅' : '❌';
            const status = result ? 'passed' : 'failed';
            
            const comment = `### E2E Test Results ${emoji}
            
            All tests have completed. Tests ${status}.
            
            Matrix: 2 OS (Ubuntu, macOS) × 2 Templates (Node.js, Python) = 4 jobs
            
            [View detailed test results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('E2E Test Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }